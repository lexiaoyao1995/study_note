### mysql何时需要给数据库添加合适索引

mysql每次查询只是用一个索引

原因：和全表扫描相比，分析两个索引更加费时间

1、有主键，和唯一键

2、在where里使用> <  >=  <=  is null 或是between ，in

3、使用不以通配符开始的like    where A like "Chin%"

4、聚集函数MIN  MAX

5、order by

6、经常做查询操作

### 何时不必使用索引

1、表记录太少

2、数据重复且分布平均

3、经常写入数据

4、经常全表扫描



### 索引何时失效

1、组合索引的最左匹配

2、like以通配符开始    where A like "%ll"

3、如果是字符串，要使用双引号  比如 where A = 'chia'会让索引失效

4、not in  ， or等会失效

### mysql 索引的底层

##### **使用的数据库是B+树**

特性

b+树是为磁盘或是其他直接存取辅助设备而设计的一种平衡查找树

b+树中，所有记录节点都是按照值的大小顺序存放在同一层叶子节点中，各叶子节点指针连接。

##### Innodb的页结构

页结构，是innodb存储引擎管理数据库的最小磁盘单位

innodb数据页组成部分

1、file header（文件头）

file header中，有两个指针，表示当前页的上一页和下一页，由此可以看出叶子节点是双向链表串起来的

2、page header（页头）

3、Records user Records（行记录）

行记录中，有两行虚拟的行记录来限定行记录的边界（infimum，supremum）

4、free space（空闲空间）

5、page directory（页目录）

page directory页目录中存放了记录的相对位置，有些时候这些记录指针称为Slots，槽，与其他数据库不同的是，innodb并不是每一个记录都拥有一个槽，innodb中的槽是一个稀疏目录，即一个槽中可以属于多个记录。

槽中记录按照键顺序存放，这样可以利用二分查找快速找到记录的指针。

但由于并不是没个行数据都有槽，所以二分查找的结果只是一个粗略的结果，所以innodb必须通过行记录的recorder header中的next_record来继续查找相关记录。

6、file trailer（文件结尾信息）

### 查询b+树索引的流程

首先通过b+树索引找到叶节点，找到相应的数据页，然后将数据页加载到内存中，通过二分查找Page directory中的槽，查找出一个相对粗略的位置，然后根据槽的指针指向链表的行数据，之后在链表中依次查找。

**需要注意的是**

b+树索引不能找到具体一条记录，而是只能找到对应的页，把页从磁盘装入内存中，再通过page directory进行二分查找，同时此二分查找也可能找不到具体的行记录，只是能找到一个接近的链表中的点，再从此点开始遍历链表进行查找。

### Mysql存储过程

Mysql5.0 版本开始支持存储过程

存储过程是一种在数据库中存储复杂程序，以便外部程序调用的一种数据库对象

存储过程是为了完成特定功能的sql语句集，经编译创建并保存在数据库中，用户可通过指定存储过程的名字并给定参数来调用执行

存储过程思想就是sql语言层面的封装和重用

**存储过程的参数**

in  out   inout



sql 并集，差集，交集

union 并集

expect 差集

inner join 交集





### 封锁协议

在运用排他锁和共享锁这两种基本封锁对数据库加锁的时候，还需要有一些规定，这些规定称为封锁协议。

通常使用三级封锁协议在不同程度上解决了更新丢失，不可重复读，以及幻读，脏读问题。

##### 一级封锁

事务A在修改数据R之前需要先加排他锁，直到事务结束，可以防止更新丢失。

**二级封锁**

在一级封锁的基础上，在读数据的时候加上共享锁，直到**读**完，可防止脏读

**三级封锁**

在一级封锁的基础上，在读数据的时候加上共享锁，直到**事务**完，可防止不可重复读

